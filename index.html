<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Recompensas DreamLAB v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: radial-gradient(circle at top, #fff0f5 0%, #fce7f3 60%, #fbcfe8 100%);
            color: #4a5568;
            padding: 2rem;
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24"><path fill="gold" d="M12 2l2.4 7.2h7.6l-6 4.8l2.4 7.2l-6-4.8l-6 4.8l2.4-7.2l-6-4.8h7.6z"/></svg>'), auto;
            overflow-x: hidden;
            position: relative;
        }
        .star-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .star-bg > div { background-color: #ffd700; width: 10px; height: 10px; border-radius: 50%; position: absolute; opacity: 0.8; animation: float 20s infinite ease-in-out; box-shadow: 0 0 5px #ffd700, 0 0 10px #ffea00; }
        @keyframes float { 0% { transform: translateY(100vh) translateX(50vw); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(-100vh) translateX(-50vw); opacity: 0; } }
        .kirby-card { border-radius: 1.5rem; padding: 1.5rem; margin-bottom: 1.5rem; transition: transform 0.2s ease-in-out; border: 2px solid; box-shadow: 0 8px 10px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -4px rgba(0, 0, 0, 0.05); }
        .ticket-bg { background-color: #ffedd5; border-color: #fdba74; }
        .badge-bg { background-color: #e0f2fe; border-color: #93c5fd; }
        .converter-bg { background-color: #ffe4e6; border-color: #fca5a5; }
        .history-bg { background-color: #f3e8ff; border-color: #c084fc; }
        .kirby-input { width: 100%; padding: 0.75rem; border-radius: 0.75rem; border: 1px solid #d1d5db; background-color: #fff; margin-top: 0.5rem; transition: all 0.2s ease-in-out; }
        .kirby-input:focus { outline: none; border-color: #ec4899; box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.5); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 9999px; font-weight: 600; transition: all 0.2s ease-in-out; box-shadow: 0 4px 0px #be185d; }
        .btn-primary { background-color: #ec4899; color: white; border: none; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 0px #be185d; }
        .btn-secondary { background-color: #a855f7; color: white; border: none; box-shadow: 0 4px 0px #7e22ce; }
        .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 6px 0px #7e22ce; }
        .btn-danger { background-color: #ef4444; color: white; border: none; box-shadow: 0 4px 0px #b91c1c; }
        .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 0px #b91c1c; }
        .ticket-display { display: none; position: relative; }
        .ticket-display.active { display: block; }
        .message-bubble { background-color: #fff; color: #be185d; border-radius: 1.5rem; padding: 1rem; font-style: italic; font-weight: 600; text-align: center; margin-top: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .star-icon, .badge-icon { font-size: 3rem; display: inline-block; filter: drop-shadow(0 4px 3px rgba(0, 0, 0, 0.2)); }
        .star-icon { animation: pulse 1.5s infinite; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(5px); }
        .modal-content { background-color: #fff; margin: 15% auto; padding: 2rem; border-radius: 1.5rem; width: 80%; max-width: 400px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .tab-btn { padding: 0.75rem 1.5rem; border-radius: 9999px; font-weight: 600; transition: all 0.2s ease-in-out; box-shadow: 0 4px 0px #be185d; background-color: #ec4899; color: white; border: none; margin: 0.5rem; }
        .tab-btn:hover { transform: translateY(-2px); box-shadow: 6px 0px #be185d; }
        .tab-btn.active { transform: translateY(2px); box-shadow: 0 2px 0px #be185d; }
        .tab-content { display: none; position: relative; top: -2px; z-index: 1; }
        .tab-content.active { display: block; }
        .title-outline { text-shadow: -1.5px -1.5px 0 #fff, 1.5px -1.5px 0 #fff, -1.5px 1.5px 0 #fff, 1.5px 1.5px 0 #fff; }
        .glowing-effect { animation: glowing 2s infinite; }
        .ticket-bg.glowing-effect { box-shadow: 0 0 10px #fdba74, 0 0 20px #fdba74, 0 8px 10px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -4px rgba(0, 0, 0, 0.05); }
        .badge-bg.glowing-effect { box-shadow: 0 0 10px #93c5fd, 0 0 20px #93c5fd, 0 8px 10px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -4px rgba(0, 0, 0, 0.05); }
        .converter-bg.glowing-effect { box-shadow: 0 0 10px #fca5a5, 0 0 20px #fca5a5, 0 8px 10px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -4px rgba(0, 0, 0, 0.05); }
        .history-bg.glowing-effect { box-shadow: 0 0 10px #c084fc, 0 0 20px #c084fc, 0 8px 10px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -4px rgba(0, 0, 0, 0.05); }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes glowing { 0% { box-shadow: 0 0 5px rgba(0,0,0,0.1); } 50% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 30px rgba(255, 255, 255, 0.6); } 100% { box-shadow: 0 0 5px rgba(0,0,0,0.1); } }
        .footer-stripe { background-color: #fce7f3; border-top: 4px solid #f472b6; padding: 1rem 0; margin-top: 2rem; }
        .kirby-svg-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 120px; height: 120px; z-index: 100; opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; }
        .kirby-svg-container.show { opacity: 1; }
        .email-feedback { display: none; text-align: center; color: #be185d; font-weight: 600; margin-top: 1rem; font-size: 0.875rem; animation: fadeIn 0.5s ease-out; }
        .email-feedback.show { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #history-table-container { max-height: 400px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 0.75rem; }
        #history-table { width: 100%; border-collapse: collapse; }
        #history-table th, #history-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        #history-table th { background-color: #faf5ff; color: #6b21a8; position: sticky; top: 0; }
        #history-table tr:last-child td { border-bottom: none; }
    </style>
</head>
<body>

    <div class="star-bg"></div>

    <div class="container">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-pink-500 title-outline">Generador de Recompensas DreamLAB</h1>
            <p class="text-lg text-slate-600 mt-2">Crea tickets y insignias para tus Bio-H√©roes</p>
        </header>

        <main>
            <nav class="flex justify-center mb-6 flex-wrap">
                <button class="tab-btn active" data-tab="estrellas">Estrellas de cr√©dito</button>
                <button class="tab-btn" data-tab="insignias">Insignias de Tesoros</button>
                <button class="tab-btn" data-tab="convertidor">Convertidor EC ‚≠ê a PC ‚ù§Ô∏è</button>
                <button class="tab-btn" data-tab="historial">Historial üìú</button>
            </nav>

            <div id="estrellas" class="tab-content active">
                <section class="kirby-card ticket-bg glowing-effect">
                    <h2 class="text-2xl font-bold text-pink-600 mb-4 title-outline">Generar Ticket de Estrellas de Cr√©ditos ‚≠ê</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="ec-amount" class="block text-sm font-medium text-slate-700">Cantidad de Estrellas de Cr√©ditos</label>
                            <input type="number" id="ec-amount" class="kirby-input" placeholder="Ej: 50" min="1" required>
                        </div>
                        <div>
                            <label for="student-name-ec" class="block text-sm font-medium text-slate-700">Nombre(s) del Alumno(s)</label>
                            <input type="text" id="student-name-ec" class="kirby-input" placeholder="Ej: Juan P√©rez" required>
                        </div>
                        <div>
                            <label for="activity-ec" class="block text-sm font-medium text-slate-700">Actividad o Misi√≥n</label>
                            <input type="text" id="activity-ec" class="kirby-input" placeholder="Ej: Presentaci√≥n de un Tema" required>
                        </div>
                        <div class="flex justify-center md:justify-end">
                            <button id="generate-ec-btn" class="btn btn-primary">Generar Ticket</button>
                        </div>
                    </div>
                </section>
                
                <div id="ec-ticket-display" class="ticket-display kirby-card ticket-bg">
                    <div class="text-center">
                        <div class="star-icon">‚≠ê</div>
                        <h3 class="text-2xl font-bold text-slate-800 mt-2 mb-1">¬°Ticket de Estrellas de Cr√©ditos!</h3>
                        <p class="text-sm text-slate-500 mb-4" id="ec-ticket-date"></p>
                    </div>
                    <div class="text-center space-y-2">
                        <p class="text-xl font-semibold text-slate-700">Alumno(s): <span class="font-bold text-pink-600" id="ticket-student-name"></span></p>
                        <p class="text-lg text-slate-600">Por la actividad: <span class="font-semibold" id="ticket-activity"></span></p>
                        <p class="text-3xl font-bold text-pink-600"><span id="ticket-ec-amount"></span> Estrellas de Cr√©ditos</p>
                        <p class="text-xs text-slate-400 mt-2">Folio: <span id="ticket-folio"></span></p>
                    </div>
                    <div class="message-bubble" id="ticket-message"></div>
                    <div class="mt-4 space-y-2">
                        <div class="flex justify-center space-x-4">
                            <button id="download-ec-pdf-btn" class="btn btn-primary">Descargar PDF</button>
                            <button id="send-ec-email-btn" class="btn btn-primary">Gui√≥n para correo</button>
                        </div>
                        <div id="ec-email-feedback" class="email-feedback"></div>
                    </div>
                </div>
            </div>

            <div id="insignias" class="tab-content">
                <section class="kirby-card badge-bg glowing-effect">
                    <h2 class="text-2xl font-bold text-pink-600 mb-4 title-outline">Generar Insignia de Tesoro ‚ú®</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="badge-type" class="block text-sm font-medium text-slate-700">Tipo de Tesoro</label>
                            <select id="badge-type" class="kirby-input" required>
                                <option value="">Selecciona un tesoro...</option>
                                <option value="innovacion">Tesoro de Innovaci√≥n ‚öôÔ∏è</option>
                                <option value="iniciativa">Tesoro de Iniciativa y Compromiso Social ü§ù</option>
                                <option value="exploracion">Tesoro de Exploraci√≥n üîç</option>
                                <option value="conexion">Tesoro de Conexi√≥n Humana üîó</option>
                            </select>
                        </div>
                        <div>
                            <label for="student-name-badge" class="block text-sm font-medium text-slate-700">Nombre(s) del Alumno(s)</label>
                            <input type="text" id="student-name-badge" class="kirby-input" placeholder="Ej: Ana L√≥pez y Pedro G√≥mez" required>
                        </div>
                        <div class="flex justify-center md:justify-end">
                            <button id="generate-badge-btn" class="btn btn-primary">Generar Insignia</button>
                        </div>
                    </div>
                </section>

                <div id="badge-display" class="ticket-display kirby-card badge-bg">
                    <div class="text-center">
                        <div class="badge-icon" id="badge-symbol"></div>
                        <h3 class="text-2xl font-bold text-slate-800 mt-2 mb-1" id="badge-title"></h3>
                        <p class="text-sm text-slate-500 mb-4" id="badge-date"></p>
                    </div>
                    <div class="text-center space-y-2">
                        <p class="text-xl font-semibold text-slate-700">Alumno(s): <span class="font-bold text-pink-600" id="badge-student-name"></span></p>
                        <p class="text-lg text-slate-600">Has ganado: <span class="font-semibold text-pink-600" id="badge-ec-amount"></span></p>
                        <p class="text-xs text-slate-400 mt-2">Folio: <span id="badge-folio"></span></p>
                    </div>
                    <div class="message-bubble" id="badge-message"></div>
                    <div class="mt-4 space-y-2">
                        <div class="flex justify-center space-x-4">
                            <button id="download-badge-pdf-btn" class="btn btn-primary">Descargar PDF</button>
                            <button id="send-badge-email-btn" class="btn btn-primary">Gui√≥n para correo</button>
                        </div>
                        <div id="badge-email-feedback" class="email-feedback"></div>
                    </div>
                </div>
            </div>

            <div id="convertidor" class="tab-content">
                <section class="kirby-card converter-bg glowing-effect">
                    <h2 class="text-2xl font-bold text-pink-600 mb-4 title-outline">Convertir Estrellas a Puntos Coraz√≥n ‚ù§Ô∏è</h2>
                    <p class="text-sm text-slate-600 mb-4">Equivalencia: 100 Estrellas de Cr√©ditos = 5 Puntos Coraz√≥n. La conversi√≥n no es parcial.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="student-name-convert" class="block text-sm font-medium text-slate-700">Nombre(s) del Alumno(s)</label>
                            <input type="text" id="student-name-convert" class="kirby-input" placeholder="Ej: Pedro G√≥mez" required>
                        </div>
                        <div>
                            <label for="stars-to-convert" class="block text-sm font-medium text-slate-700">Estrellas a Convertir</label>
                            <input type="number" id="stars-to-convert" class="kirby-input" placeholder="Ej: 250" min="1" required>
                        </div>
                        <div class="flex justify-center md:justify-end">
                            <button id="convert-btn" class="btn btn-primary">Convertir</button>
                        </div>
                    </div>
                    <div id="converter-display" class="message-bubble hidden"></div>
                    <div id="leftover-ticket-container" class="mt-4"></div>
                </section>
            </div>

            <div id="historial" class="tab-content">
                <section class="kirby-card history-bg glowing-effect">
                    <h2 class="text-2xl font-bold text-purple-600 mb-4 title-outline">Historial de Recompensas üìú</h2>
                    <div id="history-table-container">
                        <table id="history-table">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Alumno(s)</th>
                                    <th>Detalles</th>
                                    <th>Folio</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                </tbody>
                        </table>
                    </div>
                    <div id="history-empty-state" class="text-center text-slate-500 py-8 hidden">No hay registros en el historial. ¬°Genera un ticket o insignia para empezar!</div>
                    <div class="mt-6 flex justify-center space-x-4">
                        <button id="download-history-pdf-btn" class="btn btn-secondary">Descargar Reporte PDF</button>
                        <button id="clear-history-btn" class="btn btn-danger">Limpiar Historial</button>
                    </div>
                </section>
            </div>
        </main>

        <div id="password-modal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Ingresa la Contrase√±a</h3>
                <input type="password" id="password-input" class="kirby-input text-center" placeholder="********" autocomplete="off" required>
                <div id="password-error" class="text-red-500 text-sm mt-2 hidden">Contrase√±a incorrecta.</div>
                <div class="mt-4">
                    <button id="submit-password-btn" class="btn btn-primary">Aceptar</button>
                </div>
            </div>
        </div>

        <div id="kirby-svg-container" class="kirby-svg-container">
            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="40" fill="#E66A8E" stroke="#C45A79" stroke-width="4"/>
                <circle cx="35" cy="40" r="5" fill="white"/>
                <circle cx="65" cy="40" r="5" fill="white"/>
                <circle cx="35" cy="40" r="2.5" fill="black"/>
                <circle cx="65" cy="40" r="2.5" fill="black"/>
                <path d="M40 70 C45 75, 55 75, 60 70" stroke="#C45A79" stroke-width="3" stroke-linecap="round"/>
                <circle cx="30" cy="65" r="7" fill="#F098AF" stroke="#C45A79" stroke-width="2"/>
                <circle cx="70" cy="65" r="7" fill="#F098AF" stroke="#C45A79" stroke-width="2"/>
            </svg>
        </div>

        <footer id="main-footer" class="footer-stripe text-center text-slate-500 text-sm">
            <p>¬© 2025 | Adriana A. Barrios Rodr√≠guez | Todos los derechos reservados.</p>
        </footer>
    </div>

    <script>
        // Data para el generador
        const treasures = {
            innovacion: { symbol: '‚öôÔ∏è', title: 'Tesoro de Innovaci√≥n', ec: '50 Estrellas de Cr√©ditos', messages: ["Tu ingenio ha forjado un nuevo sendero en el camino del bio-h√©roe. ¬°Adelante!", "¬°Innovaci√≥n es la clave! Cada nueva idea te acerca a la victoria, bio-h√©roe.", "El mundo necesita nuevas soluciones. Tu creatividad es un tesoro incalculable."] },
            iniciativa: { symbol: 'ü§ù', title: 'Tesoro de Iniciativa y Compromiso Social', ec: '40 Estrellas de Cr√©ditos', messages: ["Cada bio-h√©roe construye su leyenda ayudando a su comunidad. ¬°Qu√© gran paso!", "Has tomado la iniciativa para hacer del mundo un lugar mejor. ¬°Felicidades, bio-h√©roe!", "Tu compromiso inspira a todos a tu alrededor. La verdadera fuerza est√° en la acci√≥n."] },
            exploracion: { symbol: 'üîç', title: 'Tesoro de Exploraci√≥n', ec: '25 Estrellas de Cr√©ditos', messages: ["El verdadero bio-h√©roe explora lo desconocido. ¬°Tu valent√≠a abre nuevos mundos!", "Has descubierto un tesoro de conocimiento. ¬°Sigue explorando, valiente bio-h√©roe!", "Tu curiosidad te ha llevado a lugares inexplorados. ¬°El universo del saber te espera!"] },
            conexion: { symbol: 'üîó', title: 'Tesoro de Conexi√≥n Humana', ec: '75 Estrellas de Cr√©ditos', messages: ["El poder m√°s grande reside en la conexi√≥n con otros. ¬°Juntos, el camino del bio-h√©roe es invencible!", "Has tejido un lazo inquebrantable. La amistad es el m√°s grande de los tesoros.", "La colaboraci√≥n es la clave para grandes victorias. ¬°Gracias por unir a tu equipo!"] }
        };
        const congratulatoryMessages = ["¬°Sigue as√≠, Bio-H√©roe! Tu esfuerzo es la clave para la victoria.", "¬°Incre√≠ble! Cada estrella te acerca m√°s a la gloria. ¬°Felicidades, bio-h√©roe!", "El camino del bio-h√©roe est√° hecho de constancia. ¬°Gran trabajo!", "¬°Tu valent√≠a ha sido recompensada! Sigue luchando por el conocimiento."];

        // Constantes del DOM y de estado
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        const submitPasswordBtn = document.getElementById('submit-password-btn');
        const kirbySvgContainer = document.getElementById('kirby-svg-container');
        const leftoverTicketContainer = document.getElementById('leftover-ticket-container');

        const CORRECT_PASSWORD = '100888';
        const HISTORY_KEY = 'dreamlab_history';
        let currentCallback = null;
        let synthesizer = new Tone.PolySynth(Tone.Synth).toDestination();
        let history = [];

        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeHistory();
            initializeBackgroundStars();
            setupEventListeners();
        });
        
        function initializeBackgroundStars() {
            const starBg = document.querySelector('.star-bg');
            for (let i = 0; i < 30; i++) {
                const star = document.createElement('div');
                star.style.left = `${Math.random() * 100}vw`;
                star.style.top = `${Math.random() * 100}vh`;
                star.style.animationDelay = `${Math.random() * 20}s`;
                star.style.animationDuration = `${10 + Math.random() * 20}s`;
                starBg.appendChild(star);
            }
        }

        function setupEventListeners() {
            tabButtons.forEach(button => button.addEventListener('click', () => { playClickSound(); switchTab(button.dataset.tab); }));
            document.getElementById('generate-ec-btn').addEventListener('click', () => showPasswordModal(generateTicket));
            document.getElementById('generate-badge-btn').addEventListener('click', () => showPasswordModal(generateBadge));
            document.getElementById('convert-btn').addEventListener('click', () => showPasswordModal(convertStars));
            document.getElementById('download-history-pdf-btn').addEventListener('click', generateHistoryPDF);
            document.getElementById('clear-history-btn').addEventListener('click', () => showPasswordModal(clearHistory));
            submitPasswordBtn.addEventListener('click', () => {
                playClickSound();
                if (passwordInput.value === CORRECT_PASSWORD) {
                    hidePasswordModal();
                    if (currentCallback) currentCallback();
                } else {
                    passwordError.classList.remove('hidden');
                }
            });
        }
        
        // --- FUNCIONES DE HISTORIAL ---
        function initializeHistory() {
            const storedHistory = localStorage.getItem(HISTORY_KEY);
            history = storedHistory ? JSON.parse(storedHistory) : [];
            renderHistory();
        }

        function saveHistory() {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            renderHistory();
        }
        
        function addToHistory(record) {
            history.unshift(record); // A√±ade al principio para mostrar lo m√°s reciente primero
            saveHistory();
        }

        function renderHistory() {
            const tableBody = document.getElementById('history-table-body');
            const emptyState = document.getElementById('history-empty-state');
            tableBody.innerHTML = '';

            if (history.length === 0) {
                emptyState.classList.remove('hidden');
                document.getElementById('history-table-container').classList.add('hidden');
                document.getElementById('download-history-pdf-btn').disabled = true;

            } else {
                emptyState.classList.add('hidden');
                document.getElementById('history-table-container').classList.remove('hidden');
                document.getElementById('download-history-pdf-btn').disabled = false;
                history.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.type}</td>
                        <td>${record.name}</td>
                        <td>${record.details}</td>
                        <td>${record.folio}</td>
                        <td>${record.date}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }
        
        function clearHistory() {
            if (confirm('¬øEst√°s seguro de que quieres borrar todo el historial? Esta acci√≥n no se puede deshacer.')) {
                history = [];
                saveHistory();
                alert('El historial ha sido borrado.');
            }
        }

        // --- FUNCIONES DE UTILIDAD ---
        function playSound(notes, duration) {
            if (Tone.context.state !== 'running') Tone.context.resume();
            synthesizer.triggerAttackRelease(notes, duration);
        }
        function playClickSound() { playSound(['C5', 'G5'], '8n'); }
        function playRewardSound() { playSound(['C6', 'E6', 'G6'], '4n'); }

        function showKirby() {
            kirbySvgContainer.classList.add('show');
            setTimeout(() => kirbySvgContainer.classList.remove('show'), 2000);
        }

        function generateFolio() {
            const now = new Date();
            const parts = {
                year: now.getFullYear(),
                month: String(now.getMonth() + 1).padStart(2, '0'),
                day: String(now.getDate()).padStart(2, '0'),
                h: String(now.getHours()).padStart(2, '0'),
                m: String(now.getMinutes()).padStart(2, '0'),
                s: String(now.getSeconds()).padStart(2, '0'),
                ms: String(Math.floor(Math.random() * 1000)).padStart(3, '0')
            };
            return `${parts.year}${parts.month}${parts.day}-${parts.h}${parts.m}${parts.s}-${parts.ms}`;
        }

        function switchTab(tabId) {
            tabContents.forEach(content => content.classList.remove('active'));
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        }

        function showPasswordModal(callback) {
            currentCallback = callback;
            passwordModal.style.display = 'block';
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            passwordInput.focus();
        }

        function hidePasswordModal() {
            passwordModal.style.display = 'none';
        }

        async function generatePDF(elementId, filename) {
            const element = document.getElementById(elementId);
            const originalStyle = element.style.border;
            element.style.border = 'none';
            const footer = document.getElementById('main-footer').cloneNode(true);
            element.appendChild(footer);

            window.jsPDF = window.jspdf.jsPDF;
            const doc = new jsPDF('p', 'mm', 'a4');
            const margin = 10;
            const contentWidth = 210 - 2 * margin;

            try {
                const canvas = await html2canvas(element, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const ratio = contentWidth / canvas.width;
                const newHeight = canvas.height * ratio;
                doc.addImage(imgData, 'PNG', margin, margin, contentWidth, newHeight);
                doc.save(filename);
            } catch (error) {
                console.error("Error generating PDF:", error);
            } finally {
                element.removeChild(footer);
                element.style.border = originalStyle;
            }
        }
        
        async function generateHistoryPDF() {
            if (history.length === 0) {
                alert("No hay historial para generar un reporte.");
                return;
            }

            const reportContainer = document.createElement('div');
            reportContainer.id = 'pdf-report-container';
            reportContainer.style.position = 'absolute';
            reportContainer.style.left = '-9999px';
            reportContainer.style.width = '1000px';
            reportContainer.style.padding = '20px';
            reportContainer.style.backgroundColor = 'white';
            
            const reportDate = new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
            
            let tableHTML = `<h2 style="text-align: center; color: #6b21a8; font-size: 24px;">Historial de Recompensas DreamLAB</h2>`;
            tableHTML += `<p style="text-align: center; color: #555; font-size: 16px;">Fecha del Reporte: ${reportDate}</p>`;
            tableHTML += `<table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-family: 'Poppins', sans-serif;">
                            <thead>
                                <tr style="background-color: #faf5ff;">
                                    <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: left; color: #6b21a8;">Tipo</th>
                                    <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: left; color: #6b21a8;">Alumno(s)</th>
                                    <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: left; color: #6b21a8;">Detalles</th>
                                    <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: left; color: #6b21a8;">Folio</th>
                                    <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: left; color: #6b21a8;">Fecha</th>
                                </tr>
                            </thead><tbody>`;

            history.forEach(record => {
                tableHTML += `<tr>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${record.type}</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${record.name}</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${record.details}</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${record.folio}</td>
                                <td style="padding: 8px; border: 1px solid #e5e7eb;">${record.date}</td>
                              </tr>`;
            });
            tableHTML += '</tbody></table>';

            reportContainer.innerHTML = tableHTML;
            document.body.appendChild(reportContainer);

            await generatePDF('pdf-report-container', `Reporte_Historial_DreamLAB_${reportDate.replace(/\s/g, '_')}.pdf`);

            document.body.removeChild(reportContainer);
        }

        function copyToClipboard(text, feedbackId) {
            navigator.clipboard.writeText(text).then(() => {
                const feedbackEl = document.getElementById(feedbackId);
                feedbackEl.textContent = '¬°Contenido copiado! Ahora puedes pegarlo en un correo.';
                feedbackEl.classList.add('show');
                setTimeout(() => feedbackEl.classList.remove('show'), 5000);
            }).catch(err => {
                console.error('Error al copiar:', err);
            });
        }
        
        function validateFields(...fields) {
            return fields.every(field => field && field.trim() !== '');
        }

        // --- FUNCIONES DE GENERACI√ìN ---
        function generateTicket() {
            const amount = document.getElementById('ec-amount').value;
            const name = document.getElementById('student-name-ec').value;
            const activity = document.getElementById('activity-ec').value;

            if (!validateFields(amount, name, activity)) {
                alert('Por favor, completa todos los campos para generar el ticket.');
                return;
            }

            const date = new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
            const folio = generateFolio();
            
            document.getElementById('ticket-ec-amount').textContent = amount;
            document.getElementById('ticket-student-name').textContent = name;
            document.getElementById('ticket-activity').textContent = activity;
            document.getElementById('ec-ticket-date').textContent = date;
            document.getElementById('ticket-message').textContent = congratulatoryMessages[Math.floor(Math.random() * congratulatoryMessages.length)];
            document.getElementById('ticket-folio').textContent = folio;

            document.getElementById('ec-ticket-display').classList.add('active');
            
            addToHistory({ type: 'Ticket de Cr√©dito', name, details: `${amount} Estrellas por: ${activity}`, folio, date });

            playRewardSound();
            showKirby();

            document.getElementById('download-ec-pdf-btn').onclick = () => generatePDF('ec-ticket-display', `Ticket_Estrellas_${folio}.pdf`);
            document.getElementById('send-ec-email-btn').onclick = () => {
                const subject = `¬°Felicitaciones! Recibiste un Ticket de Estrellas de Cr√©dito`;
                const body = `Hola ${name},\n\nAqu√≠ est√° tu ticket de Estrellas de Cr√©ditos.\n\nRecuerda adjuntar el PDF que se acaba de descargar. ¬°Gracias por tu esfuerzo!`;
                copyToClipboard(`Asunto: ${subject}\n\nCuerpo: ${body}`, 'ec-email-feedback');
            };
        }

        function generateBadge() {
            const type = document.getElementById('badge-type').value;
            const name = document.getElementById('student-name-badge').value;

            if (!validateFields(type, name)) {
                alert('Por favor, selecciona un tesoro y completa el nombre.');
                return;
            }

            const treasure = treasures[type];
            const date = new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
            const folio = generateFolio();

            document.getElementById('badge-symbol').textContent = treasure.symbol;
            document.getElementById('badge-title').textContent = treasure.title;
            document.getElementById('badge-student-name').textContent = name;
            document.getElementById('badge-ec-amount').textContent = treasure.ec;
            document.getElementById('badge-date').textContent = date;
            document.getElementById('badge-message').textContent = treasure.messages[Math.floor(Math.random() * treasure.messages.length)];
            document.getElementById('badge-folio').textContent = folio;

            document.getElementById('badge-display').classList.add('active');
            
            addToHistory({ type: `Insignia: ${treasure.title}`, name, details: `Gan√≥ ${treasure.ec}`, folio, date });

            playRewardSound();
            showKirby();
            
            document.getElementById('download-badge-pdf-btn').onclick = () => generatePDF('badge-display', `Insignia_${type}_${folio}.pdf`);
            document.getElementById('send-badge-email-btn').onclick = () => {
                const subject = `¬°Felicitaciones! Ganaste la insignia de ${treasure.title}`;
                const body = `Hola ${name},\n\n¬°Has ganado la insignia de ${treasure.title}!\n\nRecuerda adjuntar el PDF que se acaba de descargar. ¬°Sigue as√≠!`;
                copyToClipboard(`Asunto: ${subject}\n\nCuerpo: ${body}`, 'badge-email-feedback');
            };
        }

        function convertStars() {
            const name = document.getElementById('student-name-convert').value;
            const stars = parseInt(document.getElementById('stars-to-convert').value, 10);
            const converterDisplay = document.getElementById('converter-display');

            if (!validateFields(name) || isNaN(stars) || stars <= 0) {
                converterDisplay.textContent = 'Por favor, completa el nombre y una cantidad v√°lida de estrellas.';
                converterDisplay.classList.remove('hidden');
                return;
            }

            const convertedPoints = Math.floor(stars / 100) * 5;
            const remainingStars = stars % 100;
            const date = new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
            const folio = generateFolio();

            converterDisplay.innerHTML = `<div id="canje-reporte-pdf" class="space-y-2 p-2">
                    <p>Reporte de Canje para: <span class="font-bold text-pink-600">${name}</span></p>
                    <p>Fecha de conversi√≥n: ${date}</p>
                    <p>Has obtenido <span class="text-pink-600 font-bold">${convertedPoints}</span> Puntos Coraz√≥n ‚ù§Ô∏è.</p>
                    <p class="text-xs text-slate-400 mt-2">Folio de canje: ${folio}</p>
                </div>
                <div class="mt-4 space-y-2">
                    <div class="flex justify-center space-x-4">
                        <button id="download-convert-pdf-btn" class="btn btn-primary">Descargar PDF</button>
                        <button id="send-convert-email-btn" class="btn btn-primary">Gui√≥n para correo</button>
                    </div>
                    <div id="convert-email-feedback" class="email-feedback"></div>
                </div>`;
            converterDisplay.classList.remove('hidden');
            
            addToHistory({ type: 'Canje a Puntos Coraz√≥n', name, details: `${stars} EC -> ${convertedPoints} PC`, folio, date });

            leftoverTicketContainer.innerHTML = '';
            if (remainingStars > 0) {
                const leftoverFolio = generateFolio();
                leftoverTicketContainer.innerHTML = `<div class="kirby-card ticket-bg mt-4">
                        <div class="text-center" id="estrellas-sobrantes-pdf">
                            <div class="star-icon">‚≠ê</div>
                            <h3 class="text-2xl font-bold text-slate-800 mt-2 mb-1">¬°Ticket de Estrellas Sobrantes!</h3>
                            <p class="text-sm text-slate-500 mb-4">Fecha: ${date}</p>
                            <p class="text-xl font-semibold text-slate-700">Alumno(s): <span class="font-bold text-pink-600">${name}</span></p>
                            <p class="text-3xl font-bold text-pink-600">${remainingStars} Estrellas de Cr√©ditos</p>
                            <p class="text-xs text-slate-400 mt-2">Folio: ${leftoverFolio}</p>
                            <div class="message-bubble mt-4">Tus estrellas sobrantes se han guardado en la b√≥veda para tu siguiente canje.</div>
                        </div>
                        <div class="mt-4 space-y-2">
                            <div class="flex justify-center space-x-4">
                                <button id="download-leftover-pdf-btn" class="btn btn-primary">Descargar PDF</button>
                                <button id="send-leftover-email-btn" class="btn btn-primary">Gui√≥n para correo</button>
                            </div>
                            <div id="leftover-email-feedback" class="email-feedback"></div>
                        </div>
                    </div>`;
                
                addToHistory({ type: 'Ticket Sobrantes', name, details: `${remainingStars} Estrellas restantes`, folio: leftoverFolio, date });
                
                document.getElementById('download-leftover-pdf-btn').onclick = () => generatePDF('estrellas-sobrantes-pdf', `Ticket_Sobrantes_${leftoverFolio}.pdf`);
                document.getElementById('send-leftover-email-btn').onclick = () => {
                    const subject = '¬°Tus estrellas sobrantes ya est√°n listas!';
                    const body = `Hola ${name},\n\nAqu√≠ est√° tu ticket con las estrellas que te sobraron de tu canje. Puedes guardarlo para tu pr√≥xima conversi√≥n.\n\nRecuerda adjuntar el PDF que se acaba de descargar.`;
                    copyToClipboard(`Asunto: ${subject}\n\nCuerpo: ${body}`, 'leftover-email-feedback');
                };
            }

            playRewardSound();
            showKirby();
            
            document.getElementById('download-convert-pdf-btn').onclick = () => generatePDF('canje-reporte-pdf', `Reporte_Canje_${folio}.pdf`);
            document.getElementById('send-convert-email-btn').onclick = () => {
                const subject = 'Reporte de Canje de Puntos Coraz√≥n';
                const body = `Hola ${name},\n\nAqu√≠ est√° el reporte de tu canje de estrellas de cr√©dito a puntos coraz√≥n.\n\nRecuerda adjuntar el PDF que se acaba de descargar.`;
                copyToClipboard(`Asunto: ${subject}\n\nCuerpo: ${body}`, 'convert-email-feedback');
            };
        }
    </script>
</body>
</html>
